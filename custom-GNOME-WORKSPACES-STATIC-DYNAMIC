#!/usr/bin/env bash

# Function to check for required commands and offer installation
check_dependencies() {
    local missing_deps=()
    for cmd in whiptail gsettings; do
        if ! command -v "$cmd" &>/dev/null; then
            missing_deps+=("$cmd")
        fi
    done

    if [ ${#missing_deps[@]} -gt 0 ]; then
        echo "Error: Missing required dependencies: ${missing_deps[*]}"
        if command -v apt-get &>/dev/null; then
            if (whiptail --title "Missing Dependencies" --yesno "The following dependencies are missing: ${missing_deps[*]}.\n\nWould you like to try and install them now using 'apt'?" 10 60); then
                # whiptail is in 'whiptail', gsettings in 'libglib2.0-bin'
                sudo apt-get update && sudo apt-get install -y whiptail libglib2.0-bin
                # Re-check after install attempt
                for cmd in "${missing_deps[@]}"; do
                    if ! command -v "$cmd" &>/dev/null; then
                        whiptail --title "Installation Failed" --msgbox "Failed to install '$cmd'. Please install it manually and run the script again." 8 78
                        exit 1
                    fi
                done
            else
                whiptail --title "Aborted" --msgbox "Cannot continue without dependencies. Exiting." 8 78
                exit 1
            fi
        else
            whiptail --title "Error" --msgbox "Missing dependencies: ${missing_deps[*]}.\nPlease install them manually." 8 78
            exit 1
        fi
    fi
}

main() {
    local CHOICE
    CHOICE=$(whiptail --title "GNOME Workspace Configuration" --menu "Choose the workspace mode:" 15 60 2 \
        "1" "Dynamic Workspaces (Default)" \
        "2" "Static Workspaces (Fixed Number)" 3>&1 1>&2 2>&3)

    # Exit if user presses Esc or Cancel
    if [ $? -ne 0 ]; then
        echo "User cancelled. Exiting."
        exit 0
    fi

    case "$CHOICE" in
    1)
        gsettings set org.gnome.mutter dynamic-workspaces true
        whiptail --title "Success" --msgbox "Workspaces are now set to DYNAMIC." 8 78
        echo "Done: Workspaces are now dynamic."
        ;;
    2)
        local NUM_STATIC_WORKSPACES
        NUM_STATIC_WORKSPACES=$(whiptail --backtitle "Static Workspace Setup" --title "Choose Number of Static Workspaces" --menu "Select the desired number of workspaces:" 15 60 3 \
            "4" "[ 4 ] Workspaces" \
            "6" "[ 6 ] Workspaces" \
            "8" "[ 8 ] Workspaces" 3>&1 1>&2 2>&3)

        if [ -z "$NUM_STATIC_WORKSPACES" ]; then
            echo "User cancelled. No changes made."
            exit 0
        fi

        gsettings set org.gnome.mutter dynamic-workspaces false
        gsettings set org.gnome.desktop.wm.preferences num-workspaces "$NUM_STATIC_WORKSPACES"
        whiptail --title "Success" --msgbox "Workspaces are now STATIC with [$NUM_STATIC_WORKSPACES] workspaces available." 8 78
        echo "Done: Workspaces are now static with [$NUM_STATIC_WORKSPACES] workspaces available."
        ;;
    esac
}

# Run dependency check then main function
check_dependencies
main
